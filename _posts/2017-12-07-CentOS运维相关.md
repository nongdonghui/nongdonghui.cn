---
layout: post
title: CentOS运维相关
categories: centos
lastUpdated:
---

## {{ page.title }}

{{ page.date | date: "%Y.%-m.%-d" }} | <a href="/archive#{{ page.categories }}">{{ page.categories}}</a>

1.Nginx查看并发链接数

需要配置status模块

nginx.conf,在server里面加入如下内容:

```
location /nginx_status {
   stub_status on;
   access_log /usr/local/nginx/logs/status.log;
   auth_basic "nginx_status";
}
```

配置后检查

```
/usr/local/nginx/sbin/nginx -t
```

重新加载配置文件

```
/usr/local/nginx/sbin/nginx -s reload
```

查看结果说明:
Active connections    //当前 Nginx 正处理的活动连接数.
server accepts handledrequests  //总共处理了387142个连接,成功创建387142次握手,总共处理了4804888个请求.
Reading         //nginx 读取到客户端的 Header 信息数.
Writing         //nginx 返回给客户端的 Header 信息数.
Waiting         //开启 keep-alive 的情况下,这个值等于active-(reading+writing),意思就是Nginx已经处理完正在等候下一次请求指令的驻留连接.

2.通过命令查看

```
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a,S[a]}'
```

结果说明
 
SYN_RECV        //一个连接请求已经到达，等待确认
ESTABLISHED     //正常数据传输状态/当前并发连接数
FIN_WAIT2       //另一边已同意释放
ITMED_WAIT          //等待所有分组死掉
CLOSING         //两边同时尝试关闭
TIME_WAIT       //另一边已初始化一个释放
LAST_ACK        //等待所有分组死掉

3.查看使用过高的进程,然后dump出该进程的所有线程及状态

使用命令 jstack PID 命令打印出CPU占用过高进程的线程栈.

```
jstack -l 5683 > 5683.stack
```

4.使用top命令找到耗cpu的线程

```
 使用top -H -p PID 命令查看对应进程是哪个线程占用CPU过高.
```

5.
# ./jstack -l 20409 > 20409.log
20409: Unable to open socket file: target process not responding or HotSpot VM not loaded
The -F option can be used when the target process is not responding

说明在/tmp/hsperfdata_$username下没有20409这个进程文件

打印在/tmp/hsperfdata_$username下有的进程文件,使用printf "%x\n" 20509得到nid,在20509.log查找对应的代码片段

6.关闭tomcat后关闭java进程

```
# ps -e|grep java
```

```
# kill -9 进程号
```

**更新列表：**

*



**参考文章：**

* [Nginx查看并发链接数][1]
* [分析java程序中cpu占用过高的线程][2]
* [Linux下用jmap命令进行堆栈转储][3]
* [jmap、jstack、jps无法连接jvm解决办法][4]
* [centos 关闭多余的java进程][5]

[1]: http://blog.csdn.net/lsbhjshyn/article/details/10922313
[2]: http://blog.csdn.net/jgwei/article/details/12079147
[3]: http://www.linuxidc.com/Linux/2012-08/68622.htm
[4]: http://blog.51cto.com/zhangshaoxiong/1310166
[5]: https://my.oschina.net/youway/blog/387005
