---
layout: post
title: CentOS运维相关
categories: centos
lastUpdated:
---

## {{ page.title }}

{{ page.date | date: "%Y.%-m.%-d" }} | <a href="/archive#{{ page.categories }}">{{ page.categories}}</a>

1.Nginx查看并发链接数

需要配置status模块

nginx.conf,在server里面加入如下内容:

```
location /nginx_status {
   stub_status on;
   access_log /usr/local/nginx/logs/status.log;
   auth_basic "nginx_status";
}
```

配置后检查

```
/usr/local/nginx/sbin/nginx -t
```

重新加载配置文件

```
/usr/local/nginx/sbin/nginx -s reload
```

查看结果说明:
Active connections    //当前 Nginx 正处理的活动连接数.
server accepts handledrequests  //总共处理了387142个连接,成功创建387142次握手,总共处理了4804888个请求.
Reading         //nginx 读取到客户端的 Header 信息数.
Writing         //nginx 返回给客户端的 Header 信息数.
Waiting         //开启 keep-alive 的情况下,这个值等于active-(reading+writing),意思就是Nginx已经处理完正在等候下一次请求指令的驻留连接.

2.通过命令查看

```
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a,S[a]}'
```

结果说明
 
SYN_RECV        //一个连接请求已经到达，等待确认
ESTABLISHED     //正常数据传输状态/当前并发连接数
FIN_WAIT2       //另一边已同意释放
ITMED_WAIT          //等待所有分组死掉
CLOSING         //两边同时尝试关闭
TIME_WAIT       //另一边已初始化一个释放
LAST_ACK        //等待所有分组死掉

3.查看使用过高的进程,然后dump出该进程的所有线程及状态

使用命令 jstack PID 命令打印出CPU占用过高进程的线程栈.

```
jstack -l 5683 > 5683.stack
```

4.使用top命令找到耗cpu的线程

```
 使用top -H -p PID 命令查看对应进程是哪个线程占用CPU过高.
```

5.
# ./jstack -l 20409 > 20409.log
20409: Unable to open socket file: target process not responding or HotSpot VM not loaded
The -F option can be used when the target process is not responding

说明在/tmp/hsperfdata_$username下没有20409这个进程文件

打印在/tmp/hsperfdata_$username下有的进程文件,使用printf "%x\n" 20509得到nid,在20509.log查找对应的代码片段

6.关闭tomcat后关闭java进程

```
# ps -e|grep java
```

```
# kill -9 进程号
```

7.端口

* 查看端口状态:

```
/etc/init.d/iptables status
```

* 开放端口:

```
/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT  写入修改

/etc/init.d/iptables save  保存修改

service iptables restart  重启防火墙，修改生效
```

* 关闭端口:

```
/sbin/iptables -I INPUT -p tcp --dport 80 -j DROP  写入修改

/etc/init.d/iptables save  保存修改

service iptables restart  重启防火墙，修改生效
```

8.交换空间

```
新建/app/server/swap

# cd /app/server/swap
# dd if=/dev/zero of=/app/server/swap/swap bs=1024 count=64480000
     maxActive="50" maxIdle="10" minIdle="5" initialSize="5"
# mkswap /app/server/swap/swap
mkswap: /app/server/swap/swap: warning: don't erase bootbits sectors
        on whole disk. Use -f to force.
Setting up swapspace version 1, size = 64479996 KiB
no label, UUID=4a7c3567-6273-4544-b57b-3692fc692430

# free -g

# swapon /app/server/swap/swap
启用交换空间

# free -g
或grep SwapTotal /proc/meminfo

# vi /etc/fstab
最后加上
/app/server/swap/swap       swap                    swap    defaults        0 0
作用是开启自动挂载交换空间
```

**更新列表：**

* 2017-12-08 

Centos查看端口占用情况和开启端口命令详解
Centos系统增加swap空间大小的方法


**参考文章：**

* [Nginx查看并发链接数][1]
* [分析java程序中cpu占用过高的线程][2]
* [Linux下用jmap命令进行堆栈转储][3]
* [jmap、jstack、jps无法连接jvm解决办法][4]
* [centos 关闭多余的java进程][5]
* [Centos查看端口占用情况和开启端口命令详解][6]
* [Centos系统增加swap空间大小的方法][7]
* [设置/修改linux上的swap交换分区的方法][8]
* [在Linux上使用交换空间][9]

[1]: http://blog.csdn.net/lsbhjshyn/article/details/10922313
[2]: http://blog.csdn.net/jgwei/article/details/12079147
[3]: http://www.linuxidc.com/Linux/2012-08/68622.htm
[4]: http://blog.51cto.com/zhangshaoxiong/1310166
[5]: https://my.oschina.net/youway/blog/387005
[6]: http://www.jb51.net/article/103028.htm
[7]: http://www.360doc.com/content/13/0526/12/11722185_288278721.shtml
[8]: http://blog.csdn.net/buxin_2008/article/details/6154768
[9]: https://www.2cto.com/os/201704/628717.html
