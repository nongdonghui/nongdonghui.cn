---
layout: post
title: CentOS运维相关
categories: centos
lastUpdated:
---

## {{ page.title }}

{{ page.date | date: "%Y.%-m.%-d" }} | <a href="/archive#{{ page.categories }}">{{ page.categories}}</a>

1.Nginx查看并发链接数

需要配置status模块

nginx.conf,在server里面加入如下内容:

```
location /nginx_status {
   stub_status on;
   access_log /usr/local/nginx/logs/status.log;
   auth_basic "nginx_status";
}
```

配置后检查

```
/usr/local/nginx/sbin/nginx -t
```

重新加载配置文件

```
/usr/local/nginx/sbin/nginx -s reload
```

查看结果说明:
Active connections    //当前 Nginx 正处理的活动连接数.
server accepts handledrequests  //总共处理了387142个连接,成功创建387142次握手,总共处理了4804888个请求.
Reading         //nginx 读取到客户端的 Header 信息数.
Writing         //nginx 返回给客户端的 Header 信息数.
Waiting         //开启 keep-alive 的情况下,这个值等于active-(reading+writing),意思就是Nginx已经处理完正在等候下一次请求指令的驻留连接.

2.通过命令查看

```
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a,S[a]}'
```

结果说明
 
SYN_RECV        //一个连接请求已经到达，等待确认
ESTABLISHED     //正常数据传输状态/当前并发连接数
FIN_WAIT2       //另一边已同意释放
ITMED_WAIT          //等待所有分组死掉
CLOSING         //两边同时尝试关闭
TIME_WAIT       //另一边已初始化一个释放
LAST_ACK        //等待所有分组死掉

3.查看使用过高的进程,然后dump出该进程的所有线程及状态

使用命令 jstack PID 命令打印出CPU占用过高进程的线程栈.

```
jstack -l 5683 > 5683.stack
```

4.使用top命令找到耗cpu的线程

```
 使用top -H -p PID 命令查看对应进程是哪个线程占用CPU过高.
```

5.
# ./jstack -l 20409 > 20409.log
20409: Unable to open socket file: target process not responding or HotSpot VM not loaded
The -F option can be used when the target process is not responding

说明在/tmp/hsperfdata_$username下没有20409这个进程文件

打印在/tmp/hsperfdata_$username下有的进程文件,使用printf "%x\n" 20509得到nid,在20509.log查找对应的代码片段

6.关闭tomcat后关闭java进程

```
# ps -e|grep java
```

```
# kill -9 进程号
```

7.端口

* 查看端口状态:

```
/etc/init.d/iptables status
```

* 开放端口:

```
/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT  写入修改

/etc/init.d/iptables save  保存修改

service iptables restart  重启防火墙，修改生效
```

* 关闭端口:

```
/sbin/iptables -I INPUT -p tcp --dport 80 -j DROP  写入修改

/etc/init.d/iptables save  保存修改

service iptables restart  重启防火墙，修改生效
```

8.交换空间

```
新建/app/server/swap

# cd /app/server/swap
# dd if=/dev/zero of=/app/server/swap/swap bs=1024 count=64480000
     maxActive="50" maxIdle="10" minIdle="5" initialSize="5"
# mkswap /app/server/swap/swap
mkswap: /app/server/swap/swap: warning: don't erase bootbits sectors
        on whole disk. Use -f to force.
Setting up swapspace version 1, size = 64479996 KiB
no label, UUID=4a7c3567-6273-4544-b57b-3692fc692430

# free -g

# swapon /app/server/swap/swap
启用交换空间

# free -g
或grep SwapTotal /proc/meminfo

# vi /etc/fstab
最后加上
/app/server/swap/swap       swap                    swap    defaults        0 0
作用是开启自动挂载交换空间
```

9.更改用户口令 passwd

终极用户能为自己和其他用户指定口令，普通用户只能修改自己的口令。命令的格式为：

```
passwd 选项 用户名
可使用的选项：
-l 锁定口令，即禁用账号。
-u 口令解锁。
-d 使账号无口令。
-f 强迫用户下次登录时修改口令。

如果默认用户名，则修改当前用户的口令。

例如：假设当前用户是andy，则下面的命令修改该用户自己的口令：

代码如下:
$ passwd
Old password:******
New password:*******
Re-enter new password:*******

如果是终极用户，能用下列形式指定任意用户的口令：

代码如下:
# passwd andy
New password:*******
Re-enter new password:*******
```
10.root用户强制踢除其它登录用户

```
w查看需要剔除的用户tty
踢出tty为pts/1用户的命令为： pkill -kill -t pts/1
```

11.查看匹配某字符的日志

查看包含spotlight login的日志

```
grep "spotlight login" test.log
```

12.修改归档目录及大小

```
show parameter db_recovery;
alter system set db_recovery_file_dest_size=10G scope=spfile;
```


**更新列表：**

* 2017-12-08 

Centos查看端口占用情况和开启端口命令详解
Centos系统增加swap空间大小的方法

* 2017-12-10
更改用户口令 passwd
Spotlight安装和使用
root用户强制踢除其它登录用户

* 2017-12-11
linux查看日志技巧
修改oracle 11GR2归档模式和归档目录及大小

**参考文章：**

* [Nginx查看并发链接数][1]
* [分析java程序中cpu占用过高的线程][2]
* [Linux下用jmap命令进行堆栈转储][3]
* [jmap、jstack、jps无法连接jvm解决办法][4]
* [centos 关闭多余的java进程][5]
* [Centos查看端口占用情况和开启端口命令详解][6]
* [Centos系统增加swap空间大小的方法][7]
* [设置/修改linux上的swap交换分区的方法][8]
* [在Linux上使用交换空间][9]
* [Linux下基本的查看用户和管理用户密码命令][10]
* [Linux 服务器运行健康状况监控利器 Spotlight on Unix 的安装与使用][11]
* [root用户强制踢除其它登录用户][12]
* [linux查看日志技巧][13]
* [linux系统中如何查看日志 (常用命令)][14]
* [修改oracle 11GR2归档模式和归档目录及大小][15]
* [Oracle错误——ORA-03113:通信通道的文件结尾 解决办法][16]

[1]: http://blog.csdn.net/lsbhjshyn/article/details/10922313
[2]: http://blog.csdn.net/jgwei/article/details/12079147
[3]: http://www.linuxidc.com/Linux/2012-08/68622.htm
[4]: http://blog.51cto.com/zhangshaoxiong/1310166
[5]: https://my.oschina.net/youway/blog/387005
[6]: http://www.jb51.net/article/103028.htm
[7]: http://www.360doc.com/content/13/0526/12/11722185_288278721.shtml
[8]: http://blog.csdn.net/buxin_2008/article/details/6154768
[9]: https://www.2cto.com/os/201704/628717.html
[10]: https://yq.aliyun.com/ziliao/25115
[11]: http://blog.csdn.net/defonds/article/details/52385360
[12]: https://www.2cto.com/os/201304/203032.html
[13]: http://blog.csdn.net/jinzhencs/article/details/56668037
[14]: http://blog.csdn.net/qq_34306360/article/details/78718167
[15]: https://www.2cto.com/database/201109/102332.html
[16]: http://blog.csdn.net/zwk626542417/article/details/39667999